{% extends 'JeroenEDCmsEDBundle::base.html.twig' %}
{% block body %}
{{ form_start(form) }}
{% if errors is iterable %}
    <ul>
        {% for error in errors %}
            <li>{{ error }}</li>
        {% endfor %}
    </ul>
{% endif %}

<p>{{ form_label(form.title) }}{{form_widget(form.title)}}</p>
<p>{{ form_label(form.rank) }}{{form_widget(form.rank)}}</p>
<p>{{ form_widget(form.register)}}</p>
<p>{{ form_widget(form.pages)}}</p>

{{ form_end(form) }}
<table>
    <thead>
        <tr>
            <th>Slug</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody class="pages">
        {% for key,page in pages %}
            <tr data-index="{{ key }}"><td>{{ page.Slug }}</td><td><a href="javascript:void(0);" data-action="edit">edit</a> | <a href="javascript:void(0);" data-action="remove">remove</a></td></tr>
        {% endfor %}
    </tbody>
</table>
<p><a href="javascript:void(0);" class="addPage">Add a page</a></p>
{{ form_start(pageform, { 'attr': {'style': 'display: none;'} }) }}

<p>{{ form_label(pageform.slug) }}{{form_widget(pageform.slug)}}</p>
<p>{{ form_label(pageform.showtitle) }}{{form_widget(pageform.showtitle)}}</p>
<p>{{ form_label(pageform.background) }}{{form_widget(pageform.background)}}</p>
<p>{{ form_label(pageform.html) }}{{form_widget(pageform.html)}}</p>
<p>{{ form_widget(pageform.register)}}</p>

{{ form_end(pageform) }}

{% endblock %}

{% block javascript %}
    <script type="text/javascript">
function openKCFinder_singleFile() {
    window.KCFinder = {};
    window.KCFinder.callBack = function(url) {
        $('.openkcfinder').val(url);
        window.KCFinder = null;
    };
    window.open('/admin/kcfinder/browse.php?type=images&opener=custom', 'kcfinder_single', "width=1280, height=720");
}
$(document).ready(function() {
    $('.addPage').click(function() {
        $('form[name=PortfolioPage]').css('display', 'block');
    });
    $('#PortfolioPage_background').click(function() {
        openKCFinder_singleFile();
    });
    $('#PortfolioPage_register').click(function() {
        var newObject = {
            Slug: $("#PortfolioPage_slug").val(),
            Background: $("#PortfolioPage_background").val(),
            Html: CKEDITOR.instances.PortfolioPage_html.getData(),
            ShowTitle: $("#PortfolioPage_showtitle")[0].checked ? true : false
        };
        var oldObjects = [];
        if ($('#Portfolio_pages').val() !== '') oldObjects = $.parseJSON($('#Portfolio_pages').val());
        if ($('#PortfolioPage_index').val() !== '') {
            var index =$('#PortfolioPage_index').val()
            oldObjects[index] = newObject;
            $('.pages tr[data-index=' + index + ']').html('<td>' + $("#PortfolioPage_slug").val() + '</td><td><a href="javascript:void(0);" data-action="edit">edit</a> | <a href="javascript:void(0);" data-action="remove">remove</a></td>');
        }else { 
            var index = oldObjects.push(newObject) - 1; 
            $('.pages').append('<tr data-index="' + index + '"><td>' + $("#PortfolioPage_slug").val() + '</td><td><a href="javascript:void(0);" data-action="edit">edit</a> | <a href="javascript:void(0);" data-action="remove">remove</a></td></tr>');
        }
        $('#Portfolio_pages').val(JSON.stringify(oldObjects));
        $('.nopages').css('display', 'none');
        $('form[name=PortfolioPage]').css('display', 'none');
        $("#PortfolioPage_slug").val('');
        $("#PortfolioPage_background").val('');
        $("#PortfolioPage_html").val('');
        CKEDITOR.instances.PortfolioPage_html.setData('');
        $("#PortfolioPage_showtitle")[0].checked = false;
        $("#PortfolioPage_index").val('');
    });
    $('table').on('click', 'a[data-action]', function() {
        var index = $(this).closest('tr').data('index');
        var pages = $.parseJSON($('#Portfolio_pages').val());
        switch ($(this).data('action')) {
            case 'edit':
                $("#PortfolioPage_slug").val(pages[index].Slug);
                $("#PortfolioPage_background").val(pages[index].Background);
                $("#PortfolioPage_html").val(pages[index].Html);
                CKEDITOR.instances.PortfolioPage_html.setData(pages[index].Html);
                $("#PortfolioPage_showtitle")[0].checked = pages[index].ShowTitle;
                $("#PortfolioPage_index").val(index);
                $('form[name=PortfolioPage]').css('display', 'block');
                break;
            case 'remove':
                if(!confirm('Are you sure you want to delete this page?')) exit;
                pages.splice(index, 1);
                $('#Portfolio_pages').val(JSON.stringify(pages));
                $('.pages tr[data-index=' + index+ ']').remove();
                if (pages.length == 0){ $('.nopages').css('display', ''); }
                
        }
    });
    CKEDITOR.replace( 'PortfolioPage[html]' );
});
</script>
{% endblock %}

